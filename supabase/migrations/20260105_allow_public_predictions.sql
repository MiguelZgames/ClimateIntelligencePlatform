-- Authorization logic for Public Predictions
-- This migration expands the base authorization scheme to allow public access to system-generated predictions.

-- 1. Policy for Public/System Predictions
-- Rationale: Predictions generated by the system (ETL/ML pipeline) usually have user_id = NULL.
-- These are considered public assets for the dashboard.
-- We use DROP IF EXISTS to ensure idempotency and avoid conflicts during sequential runs.

DROP POLICY IF EXISTS "Anyone can view system predictions" ON predictions;

CREATE POLICY "Anyone can view system predictions" 
ON predictions 
FOR SELECT 
USING (
  user_id IS NULL -- Authorization Rule: Only predictions without a specific owner are public
);

-- 2. Constraints and Permissions
-- Ensure that the 'anon' role (unauthenticated users) has explicit SELECT permission on the predictions table.
-- Note: Modification (INSERT/UPDATE/DELETE) is NOT granted to 'anon', maintaining security.

GRANT SELECT ON predictions TO anon;

-- 3. Security Note
-- Row Level Security (RLS) is already enabled on the 'predictions' table in the initial schema.
-- This policy adds to the existing policies ("Users can view own predictions", "Admin can view all predictions").
-- Postgres RLS policies are additive (OR logic for permissive policies), so:
-- A user can see a row IF (they own it) OR (they are admin) OR (it is a system prediction).
